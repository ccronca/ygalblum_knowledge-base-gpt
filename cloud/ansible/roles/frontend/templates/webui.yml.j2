---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: knowledgebase-webui
  labels:
    app: knowledgebase-webui
spec:
  replicas: 1
  selector:
    matchLabels:
      app: knowledgebase-webui
  template:
    metadata:
      labels:
        app: knowledgebase-webui
    spec:
      containers:
      - name: gradio
        image: {{ frontend_client_container_image }}
        command: ["python", "-m", "knowledge_base_gpt.apps.gradio.app"]
        ports:
        - containerPort: 7860
        volumeMounts:
        - mountPath: "/db"
          name: embedding
          readOnly: true
        env:
        - name: PERSIST_DIRECTORY
          value: "/db"
        - name: OLLAMA_HOST
          value: ollama
        securityContext:
          runAsUser: 0
      - name: oauth-proxy
        image: quay.io/oauth2-proxy/oauth2-proxy:v7.5.1
        env:
        - name: OAUTH2_PROXY_COOKIE_SECRET
          valueFrom:
            secretKeyRef:
              name: knowledgebase-oauth-proxy-cookie-secret
              key: cookie-secret
        - name: OAUTH2_PROXY_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: knowledgebase-oauth-proxy-client-info
              key: client_id
        - name: OAUTH2_PROXY_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: knowledgebase-oauth-proxy-client-info
              key: client_secret
        - name: OAUTH2_PROXY_REVERSE_PROXY
          value: "true"
        - name: OAUTH2_PROXY_EMAIL_DOMAINS
          value: "{{ frontend_oauth_email_domains }}"
        - name: OAUTH2_PROXY_WHITELIST_DOMAINS
          value: "{{ frontend_fqdn }}"
        ports:
        - containerPort: 4180
      - name: nginx
        image: docker.io/nginxinc/nginx-unprivileged:latest
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/conf.d
          readOnly: true
        - name: nginx-certs
          mountPath: /nginx_certs
        ports:
        - containerPort: 8080
          hostPort: 80
        - containerPort: 8443
          hostPort: 443
      volumes:
      - name: embedding
        persistentVolumeClaim:
          claimName: systemd-embedding
      - name: nginx-config
        configMap:
          name: knowledgebase-nginx-config
          items:
          - key: nginx.conf
            path: default.conf
      - name: nginx-certs
        secret:
          secretName: knowledgebase-webui-certs
